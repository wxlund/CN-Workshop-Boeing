= Spring Cloud Netflix: Circuit Breaker and Metric Aggregation
Wayne Lund <wxlund@pivotal.io>
v1.0, 2016-04-14

== *Part I:* Spring Cloud Netflix: Circuit Breaker

=== Start the `config-server`, `service-registry`, and `fortune-service`

1) Start the `config-server` in a terminal window. You may have terminal windows still open from previous labs. They may be reused for this lab.
```bash
$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/config-server
$ mvn clean spring-boot:run
```
2) Start the `service-registry`
```bash
$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/service-registry
$ mvn clean spring-boot:run
```

3) Start the `fortune-service`
```bash
$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/fortune-service
$ mvn clean spring-boot:run
```

Set up `greeting-hystrix`

1) Review the `$SPRING_CLOUD_SERVICES_LABS_HOME/greeting-hystrix/pom.xml` file. By adding `spring-cloud-services-starter-circuit-breaker` to the classpath this application is eligible to use circuit breakers via Hystrix.
```xml
<dependency>
	<groupId>io.pivotal.spring.cloud</groupId>
	<artifactId>spring-cloud-services-starter-circuit-breaker</artifactId>
</dependency>
```
2) Review the following file: `$SPRING_CLOUD_SERVICES_LABS_HOME/greeting-hystrix/src/main/java/io/pivotal/GreetingHystrixApplication.java`. Note the use of the `@EnableCircuitBreaker` annotation. This allows the application to create circuit breakers.

[source,java]
----
@SpringBootApplication
@EnableDiscoveryClient
@EnableCircuitBreaker
public class GreetingHystrixApplication {


    public static void main(String[] args) {
        SpringApplication.run(GreetingHystrixApplication.class, args);
    }

}
3). Review the following file: $SPRING_CLOUD_SERVICES_LABS_HOME/greeting-hystrix/src/main/java/io/pivotal/fortune/FortuneService.java. Note the use of the @HystrixCommand. This is our circuit breaker. If getFortune() fails, a fallback method defaultFortune will be invoked.

@Service
public class FortuneService {

	Logger logger = LoggerFactory
			.getLogger(FortuneService.class);

	@Autowired
	@LoadBalanced
	private RestTemplate restTemplate;

	@HystrixCommand(fallbackMethod = "defaultFortune")
	public String getFortune() {
    String fortune = restTemplate.getForObject("http://fortune-service", String.class);
		return fortune;
	}

	public String defaultFortune(){
		logger.debug("Default fortune used.");
		return "This fortune is no good. Try another.";
	}



}
----

4) Open a new terminal window. Start the `greeting-hystrix`
```bash
$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/greeting-hystrix
$ mvn clean spring-boot:run
```

5) Refresh the `greeting-hystrix` / endpoint. You should get fortunes from the `fortune-service.`

6) Stop the `fortune-service`. And refresh the `greeting-hystrix` / endpoint again. The default fortune is given.

7) Restart the fortune-service. And refresh the `greeting-hystrix` / endpoint again. After some time, fortunes from the fortune-service are back.

TIP: What Just Happened?

The circuit breaker insulated `greeting-hystrix` from failures when the fortune-service was not available. This results in a better experience for our users and can also prevent cascading failures.

Set up the `greeting-hystrix` metric stream

Being able to monitor the state of our circuit breakers is highly valuable, but first the `greeting-hystrix` application must expose the metrics.

This is accomplished by including the actuator dependency in the `greeting-hystrix` `pom.xml`.

1) Review the `$SPRING_CLOUD_SERVICES_LABS_HOME/greeting-hystrix/pom.xml` file. By adding spring-boot-starter-actuator to the classpath this application will publish metrics at the /hystrix.stream endpoint.
```xml
<dependency>
	<groupId>org.springframework.boot</groupId>
	<artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```
2) Browse to http://localhost:8080/hystrix.stream to review the metric stream.

Set up `hystrix-dashboard`

Consuming the metric stream is difficult to interpret on our own. The metric stream can be visualized with the Hystrix Dashboard.

1) Review the `$SPRING_CLOUD_SERVICES_LABS_HOME/hystrix-dashboard/pom.xml` file. By adding `spring-cloud-starter-hystrix-dashboard` to the classpath this application is exposes a Hystrix Dashboard.
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-hystrix-dashboard</artifactId>
</dependency>
```
2) Review the following file: `$SPRING_CLOUD_SERVICES_LABS_HOME/hystrix-dashboard/src/main/java/io/pivotal/HystrixDashboardApplication.java`. Note the use of the `@EnableHystrixDashboard` annotation. This creates a Hystrix Dashboard.
[source,java]
----
@SpringBootApplication
@EnableHystrixDashboard

public class HystrixDashboardApplication {

    public static void main(String[] args) {
        SpringApplication.run(HystrixDashboardApplication.class, args);
    }
}
----

3) Open a new terminal window. Start the hystrix-dashboard
```bash
$ cd $SPRING_CLOUD_SERVICES_LABS_HOME/hystrix-dashboard
$ mvn clean spring-boot:run
```

4) Open a browser to http://localhost:8686/hystrix

5) Link the `hystrix-dashboard` to the `greeting-hystrix` app. Enter http://localhost:8080/hystrix.stream as the stream to monitor.

6) Experiment! Refresh the `greeting-hystrix `/ endpoint several times. Take down the `fortune-service` app. What does the dashboard do? Review the dashboard doc for an explanation on metrics.

== *Part II* Spring Cloud Netflix: Circuit Breaker Metric Aggregation

*Congratulations!* Youâ€™ve just learned how to add the Circuit Breaker to an application.
